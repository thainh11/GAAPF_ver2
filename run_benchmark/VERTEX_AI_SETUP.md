# Vertex AI Setup Guide for GAAPF AgentBench Evaluation

This guide explains how to set up Google Cloud Vertex AI for the GAAPF AgentBench evaluation system.

## Prerequisites

1. **Google Cloud Project**: You need an active Google Cloud project with billing enabled
2. **Vertex AI API**: The Vertex AI API must be enabled in your project
3. **Authentication**: Proper authentication credentials configured

## Step 1: Create Google Cloud Project

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select an existing one
3. Note your project ID (you'll need this later)

## Step 2: Enable Vertex AI API

1. In the Google Cloud Console, go to "APIs & Services" > "Library"
2. Search for "Vertex AI API"
3. Click on it and press "Enable"

## Step 3: Set Up Authentication

### Option A: Service Account (Recommended for Production)

1. **Create Service Account**:
   ```bash
   gcloud iam service-accounts create gaapf-benchmark \
       --description="Service account for GAAPF benchmark evaluation" \
       --display-name="GAAPF Benchmark"
   ```

2. **Grant Necessary Permissions**:
   ```bash
   gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
       --member="serviceAccount:gaapf-benchmark@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
       --role="roles/aiplatform.user"
   ```

3. **Create and Download Key File**:
   ```bash
   gcloud iam service-accounts keys create gaapf-service-account.json \
       --iam-account=gaapf-benchmark@YOUR_PROJECT_ID.iam.gserviceaccount.com
   ```

4. **Set Environment Variable**:
   ```bash
   export GOOGLE_APPLICATION_CREDENTIALS="/path/to/gaapf-service-account.json"
   ```

### Option B: Application Default Credentials (For Development)

1. **Install Google Cloud CLI**:
   - Download from [Google Cloud CLI](https://cloud.google.com/sdk/docs/install)

2. **Authenticate**:
   ```bash
   gcloud auth application-default login
   ```

## Step 4: Set Environment Variables

Create a `.env` file in the `run_benchmark` directory or set these environment variables:

```bash
# Required: Your Google Cloud Project ID
export GOOGLE_CLOUD_PROJECT="your-project-id"

# Optional: Vertex AI location (default: us-central1)
export GOOGLE_CLOUD_LOCATION="us-central1"

# Required if using service account (Option A above)
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/your/service-account.json"
```

### Windows PowerShell:
```powershell
$env:GOOGLE_CLOUD_PROJECT="your-project-id"
$env:GOOGLE_CLOUD_LOCATION="us-central1"
$env:GOOGLE_APPLICATION_CREDENTIALS="C:\path\to\your\service-account.json"
```

### Windows Command Prompt:
```cmd
set GOOGLE_CLOUD_PROJECT=your-project-id
set GOOGLE_CLOUD_LOCATION=us-central1
set GOOGLE_APPLICATION_CREDENTIALS=C:\path\to\your\service-account.json
```

## Step 5: Install Dependencies

Install the updated requirements:

```bash
cd run_benchmark
pip install -r requirements.txt
```

## Step 6: Test Configuration

Test your Vertex AI setup:

```bash
python run_gaapf_benchmark.py --test-only
```

This will:
- Check all dependencies
- Verify Vertex AI configuration
- Start the API server with Vertex AI
- Test the connection
- Stop the server

## Available Vertex AI Models

The system is configured to use `gemini-1.5-flash-001` by default. You can modify the model in `start_gaapf_api_server.py` if needed:

- `gemini-1.5-pro-001` - More capable, slower
- `gemini-1.5-flash-001` - Faster, good balance (default)
- `gemini-1.0-pro` - Legacy model

## Troubleshooting

### Common Issues

1. **"Project not found" error**:
   - Verify your project ID is correct
   - Ensure the project exists and you have access

2. **"Permission denied" error**:
   - Check that Vertex AI API is enabled
   - Verify your service account has the correct roles

3. **"Credentials not found" error**:
   - Ensure `GOOGLE_APPLICATION_CREDENTIALS` points to a valid file
   - Or run `gcloud auth application-default login`

4. **"Quota exceeded" error**:
   - Check your Vertex AI quotas in the Google Cloud Console
   - Request quota increases if needed

### Verification Commands

```bash
# Check if gcloud is configured
gcloud config list

# Test Vertex AI access
gcloud ai models list --region=us-central1

# Verify authentication
gcloud auth list
```

## Logging and Monitoring

The updated system provides comprehensive logging:

- `gaapf_evaluation.log` - General application logs
- `gaapf_inputs.log` - Detailed input logging
- `gaapf_outputs.log` - Detailed output logging
- `gaapf_performance.log` - Performance metrics

These logs will help you monitor the evaluation process and debug any issues.

## Cost Considerations

Vertex AI charges based on:
- **Input tokens**: Text sent to the model
- **Output tokens**: Text generated by the model
- **Model type**: Different models have different pricing

For current pricing, see [Vertex AI Pricing](https://cloud.google.com/vertex-ai/pricing).

## Security Best Practices

1. **Never commit service account keys** to version control
2. **Use least privilege principle** - only grant necessary permissions
3. **Rotate service account keys** regularly
4. **Monitor usage** through Google Cloud Console
5. **Set up billing alerts** to avoid unexpected charges

## Next Steps

Once configured, you can run the full benchmark:

```bash
# Run lightweight benchmark
python run_gaapf_benchmark.py --config gaapf-lightweight-benchmark.yaml

# Run full benchmark
python run_gaapf_benchmark.py --config gaapf-full-benchmark.yaml
```

The results will be saved in `agentbench/outputs/latest_run/`.